<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Webcam Real-time Multi-Object Tracking</title>
<style>
  body { background: #222; color: #eee; font-family: Arial, sans-serif; text-align: center; margin: 20px; }
  #videoStream { border: 4px solid #09f; border-radius: 8px; }
  button { margin: 10px; font-size: 1.2em; padding: 10px 20px; }
</style>
</head>
<body>
<h1>Webcam Real-time Multi-Object Tracking</h1>
<img id="videoStream" src="{{ url_for('video_feed') }}" width="640" height="360" />
<p>
  <button onclick="selectBoxes()">Select Objects (Draw 2 boxes)</button>
  <button onclick="startTracking()" disabled id="startBtn">Start Tracking</button>
</p>

<script>
  const img = document.getElementById('videoStream');
  const startBtn = document.getElementById('startBtn');
  let boxes = [];
  let isSelecting = false;
  let startX, startY, rect;

  function selectBoxes() {
    boxes = [];
    alert('請在影片區域連續點兩次以選取兩個追蹤框（按左上角和右下角）');
    isSelecting = true;
  }

  img.addEventListener('click', (e) => {
    if (!isSelecting) return;

    const rectBounds = img.getBoundingClientRect();
    const scaleX = img.naturalWidth / rectBounds.width;
    const scaleY = img.naturalHeight / rectBounds.height;

    const x = (e.clientX - rectBounds.left) * scaleX;
    const y = (e.clientY - rectBounds.top) * scaleY;

    if (boxes.length === 0) {
      rect = { x1: x, y1: y };
      alert('請再點選第二個點');
    } else if (boxes.length === 1) {
      rect.x2 = x;
      rect.y2 = y;

      // 計算寬高
      const box = {
        x: Math.min(rect.x1, rect.x2),
        y: Math.min(rect.y1, rect.y2),
        w: Math.abs(rect.x2 - rect.x1),
        h: Math.abs(rect.y2 - rect.y1)
      };
      boxes.push(box);
      alert(`選擇框1完成：${JSON.stringify(box)}`);

      if (boxes.length >= 2) {
        isSelecting = false;
        startBtn.disabled = false;
      }
    }
  });

  function startTracking() {
    if (boxes.length === 0) {
      alert('請先選擇物件追蹤框');
      return;
    }

    fetch('/init_tracking', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ boxes })
    })
    .then(res => res.json())
    .then(data => {
      alert('追蹤已啟動！');
      startBtn.disabled = true;
    })
    .catch(e => alert('啟動追蹤失敗:' + e));
  }
</script>
</body>
</html>
